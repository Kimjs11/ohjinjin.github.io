---
title: "Time-Series Analysis(1)"
categories: 
  - MachineLearning
last_modified_at: 2020-04-17T00:18:00+09:00
toc: true
---

Intro
---
학교 수강과목에서 학습한 내용을 복습하는 용도의 포스트입니다.<br/>

본 수업에서는 R 언어를 통해 1변량 시계열 데이터를 분석하고 ARIMA 등의 정상시계열 모형을 이용하여 예측하기까지의 실습 및 이론 수업으로 진행됩니다.<br/>

실습 환경 구축으로는 R 스튜디오 설치 정도가 있겠습니다.<br/>

[실습 과제 1 보러가기](https://github.com/ohjinjin/TimeSeries_Lab/blob/master/Lab1_convert_the_frequency.ipynb)<br/>

시계열(time series)
---
하나 또는 여러 사건(사상)에 대해 **시간의 흐름**에 따라 일정한 간격으로 이들을 관찰하여 기록한 자료를 말합니다.

어떤 경제 현상이나 자연 현상에 관한 시간적 변화를 나타내는 역사적 계열(historical series)

어느 한 시점 t에서 관측된 시계열 자료는 그 이전까지의 자료들에 주로 의존합니다.

그러나 그 이전까지의 여러 요인들의 (crisis 등)변화에도 영향이 존재하기 때문에 시계열의 법칙성을 발견해서 미래를 예측(classification 또는 regression)하는 것은 매우 복잡합니다.

수업에서는 시계열 데이터만의 규칙을 발견하고 이를 머신러닝 모델 또는 통계모형으로 이를 해결하는 과정을 다룹니다.

그러기 위해서는 패턴을 분석하는 것이 가장 먼저 할 일입니다.

그렇다면 시간의 흐름에 따라 불규칙적으로 변동되는 자료들도 분석이 가능할까요?

시계열 데이터에서는 변동 요인을 보통 4가지로 가정합니다.

변동요인
---
자료들의 특성을 단순화하는 것 입니다.

1. 추세변동(trend variation)
데이터를 보았을때 그 행보가 우상향으로 상승하는가, 하락하는가, 곡선추세인가 또는 횡보하는가 하는 변동

2. 계절변동(seasonal variation)
1년 안으로 반복적으로 나타나는 패턴들, 1년 동안의 월 또는 분기 등이 여기에 해당됩니다.
다음에 나오는 순환변동하고 구분할 수 있어야합니다.

3. 순환변동(cyclival variation)
계절변동과 비교했을때 보다 장기간의 term으로 반복되는 데이터를 말합니다. 
계절변동으로는 설명되지 않는 장기적인 주기변동으로 이해하시면됩니다.
보통 추세변동이랑 같이 분석되곤 합니다. 그래서 회복기, 번역기, 후퇴기, 침체기 네 단계로 구성됩니다.

4. 불규칙변동(irregular variation)
위 세가지 변동으로 설명하지 못하는 경우에 해당합니다.
사전적으로 예상할수 없는 특수한 사건에 의해 야기되는 변동이나 명확히 설명될 수 없는 요인에 의해 발생되는 우연변동입니다.

우리는 주어진 시계열데이터를 위 네가지 성분으로 나눠 설명할 수 있습니다.

여기에 통계모형(?)을 적용시키게 되는 것 입니다.

* 승법모형(multiplicative model) 
Zt = Tt*St*Ct*It
* 가법모형(additive model)
Zt = Tt+St+Ct+It

사실 우리가 머신러닝이나 통계모형 모델들 만으로는 완벽한 예측이 불가하죠, 이를 해소하는 것이 바로 **오차**입니다. 바로 장차값을 이용해 해결하는데 그것처럼 추세, 계절, 순환으로 설명할 수 없는 것에 대해 불규칙변동을 이용함으로써 해소합니다.




활용방법
---
지수(index number)
시계열 자료들의 변화동향을 비교하기 위해 특정한 시점을 기준으로 하여 백분비를 나타낸 값입니다.

지수 종류
1. 개별지수(individual index): 변수 하나의 계열을 비교하는 지수
2. 종합지수(composite index) : 여러 계열의 변화를 종합적으로 관찰하는 지수
ex) 단순지수

둘다 값은 하나인데, 여러가지의 값들을 포함시켜 결과값을 표현해낸게 종합지수라고 보면 됩니다.

단순지수
단순총합지수(simple aggregative index) : 기준시점에서의 
단순평균지수(simple :
dd
(이미지1)


개별지수 예제
2005년 서울 지역의 쌀의 도매가가 가마당 48000원, 2010년은 72000원일때 2005년 기준 2010년의 지수는?
100*72000/48000=150%
참고로 2005년의 지수는 100%입니다.

종합지수의 예인 단순지수 예제
아래는 어느 도시의 주요 식료품 소매가격에 대한 자료이다. 2005년을 기준으로한 각 연도별 단순총합지수와 2010년의 단순평균지수를 계산하시오.

이미지2
이미지3


시계열자료의 예측방법
---
(24페이지 뛰어넘음)

양적예측방법 구분
과거에는 데이터를 가장 잘나타내는 모형을 찾는 컨셉이었으나, 현재는 확률 통계를 기반으로 예측하도록 변해가는 추세입니다.
* 전통적 시계열분석방법 : 평활법(smotthing methods), 분해법(decomposition methods) 등
* 확률적 시계열분석방법
ML의 딥러닝, ML의 RNN, 시간영역분석(time domain analysis), ARIMA(autoregressive Integrated moving average), 주파수 영역분석인 퓨리에 분석(fourier analysis) 등

ARIMA에 0.4의 가중치를 두고 ML 모델에 0.6의 가중치를 둬서 섞어 쓰기도 합니다.

질적예측방법
---
저눈가의 견해를 기반으로 예측합니다.


예측의 평가
---
보통 ML 모델 구축시 데이터를 train:test를 6:4 내지는 7:3 정도로 나누죠

시계열에서도 비슷합니다.


예측 평가방법
관측가능기간동안에는 모형의 추정 및 사전평가(validation)를 진행하며, 예측기간에는 사후평가입니다.
모형의 추정및 사전평가를 나눠할 수도 있고 함께 진행할 수도 있습니다.

보통 ML에서는 일반 data에서 sampling을 하여 train데이터와 test를 구분하는데, time series는 어떨까요?
time series는 랜덤으로 sample을 뽑으면 안됩니다.
시간 순서가 중요하기 때문이죠.
대신 기간을 나눕니다.

순서가 꼬이면 미래의 데이터를 가지고 학습하는 셈이 되어버릴 수 있어서 유의해야합니다.

예측의 평가기준
평균제곱오차(Mean Squared Error, MSE)
평균제곱근 오차(,RMSE)(가장많이 사용)
평균절대오차(MeanAbsoluteError,MAE)
평균절대백분비오차(MAPercentageError)
타일의불일치개수


시계열분석의 가장 큰목적은 결국 미래에 대한 **예측**

고전적인 시계열 모형의 경우는 주어진 데이터를 얼마만큼 잘 설명할 수 있는가일 수 있지만 그래도 궁극적으로는 예측이 목적

(이미지4,4-1설명)

시계열자료의 예측방법
과거의 패턴은 미래에서도 지속된다는 가정
관측된 과거자료에 포함된 정보를 이용하여 예측에 필요한 경험적 법칙을 추정하여 예측
과거에 대한 정보가 알고리즘 내 존재

설명모형은 종속변수와 독립변수간에 인과관계를 설명하는 것
이를테면 주어진데이터를 가장 잘 설명하는 직선을 찾는것이 선형회귀분석이죠.

시계열모형은 생성과정이라는 표현을 쓰는데, 
t번째 Y값은 t-1번째 Y로부터 영향을 받아 생성된다 하는 정도로 해석하면 되겠습니다.

둘을 간단히 구분할 수 있습니다.

양적예측방법에는 전통적 시계열분석방법으로 평활법과 분해법을 배우게 되며, 확률적 시계열분석방법으로 시간영역분석인 ARIMA만 배웁니다. 퓨리에라고 주파수 영역분석방법도 존재하지만요.

예제를 봅니다.
예측력의 사후평가를 위한 MSE, RMSE, MAE, MAPE 그리고 타일의 U통계량을 계산합니다.
(U는 자주사용되지는 않아요 그래서 다루지 않습니다)

실제값 - 예측값인 에러텀을 가지고 개선해내는것이죠.
물론 에러텀의 값은 작을 수록 좋은 것이구요.

이 측정값들을 test dataset으로만 볼것이 아닙니다. train data에 대해서도 봐야해요.
관측가능기간이 train단계, 예측기간이 test단계라고 보심 될 것같아요.
정확도를 예측하는 분류모델 (ex)accuracy)도 train, test 둘다에 대한 에러텀을 계산함으로서 나오는거에요.

모형의 일반화가 어려운 모델은 좋은 모델이라고 하기 어렵습니다

(이미지6)

사실 고전적방법은 잘 안쓸건데, 모델 비교 평가를 할때나 쓰겠네요

단순 이동평균법과 선형이동평균법을 이해해봅시다
단순이동평균법입니다.
계절성 불규칙성을 제거하여 전반적인 추세 파악 가능
가장 최근 m- 기간 동안의 자료들의 단순평균을 다음 기간의 예측값으로 추정하는 방법으로 m은 분석자에 의해 사전적으로 결정되며, m이 크면 장기 패턴, 작으면 단기 패턴을 진단합니다.

(이미지7)
우리는 지금 이동평균평활법의 단순이동평균법을 적용해 예측하는 과정을 보고있습니다.
이동평균 기간 m이라는 파라미터는 관측기간 내에서의  MSE를 최소로 하는 값으로 결정하는 것이 좋습니다.
MSE를 적용해볼거라한다면, 아래와 같은 식이 되겠습니다.

(이미지8)

예제를 풀어봅니다.


forecast에 단순이동 평균이 없어서 직접 엑셀로 해보았습 겁니다.
m=4~7일떄 각각, 차트까지 그리기



차트는 한번에 비교할 수 있도록
MSE를 구할때는 이동값들 기준이니까 데이터 개수를 맞춰서 가장 적은 m==7일때의 개수에 맞춰서 
관측된 시계열이 선형 추세성을 갖는 경우에 선형이동평균을 사용(이중이동평균)하면 더 좋다
m은 이동평균 계수 값
이중 이동평균은 한번 더 이동평균을 구하는 것을 말합니다. 
현재 시점이 n인 경우에 n+l 시점의 값을 예측하는데, 보통 l=1인 경우가 많습니다.
딱히 식을 외울 필요는 없습니다. 다만 M 값이 무엇인지는 알아야합니다.
14번 슬라이드의 예제는 t=6일때의 값을 예측하고자한 것입니다. 한번 연습을 해보세요..

페이스북주식가격을 바탕으로 평활화하기
(url 놓침) ㅠㅠ

단순이동평균법은 계수 m개를 가지고 평균을 계산하죠 동등하게!
가중이동평균법은 최근 데이터에 0.5를 곱하고 과거로 갈수록 0.3을 곱하고 0.2를 곱하고... 이렇게 하는겁니다. 원데이터에 가중치를 곱하고 다 더합니다. 가중치는 한번 정했으면 고정입니다.
(이미지9)

엑셀로 분석 합니다. fb 데이터가지고 실습할거에용..
https://finance.yahoo.com/quote/FB/history?period1=1337299200&period2=1586995200&interval=1d&filter=history&frequency=1d
(이미지13)


단순이동평균법은 계절성, 불규칙성을 제거하여 전반적인 추세 파악이 가능하다고 배웠습니다.
(이미지10)
원데이터의 경우는 어떤 패턴이 있습니다. 
계절성은 어느정도 드러나지만 m=12까지 갔을때를 보면 어떤 추세만이 드러난다는 것을 알 수 있습니다.

이동평균을 가지고 예측하는 것을 많이 하지는 않습니다.
예측방법보다는 주어진 데이터를 얼마나 잘 설명할 수 있는지에 초점을 두고 학습하면 좋을 것 같습니다.

시계열 분석의 워크플로우는  input \> filter \> output이었죠. 이동평균법도 마찬가지로 filter에 속합니다.

오늘은 단순지수 평활법을 배웁니다.

R의 forecast 패키지의 ses함수를 이용해서 실습도 해보겠습니다.

단순지수 평활법은 시계열 관측값들에 대한 가중평균인 평활값으로 미래의 관측값을 예측합니다.
단순이동평균법과는 달리 최근 자료에 더 많은 가중값을 부여하는 방식으로 0~1사이의 값을 갖는 알파라는 평활상수에 의해 지수적으로 과거로 갈수록 그 값이 미미해지게됩니다.
(이미지11)
식을 전개해 적용하다보면 아실거에요!
(이미지12)

F는 예측값 Z는 관측값이라고 보시면 됩니다.

이제 바로 위 데이터를 가지고 R로 실습해봅시다.

* 실습 보러가기 링크 : [https://github.com/ohjinjin/TimeSeries_Lab/blob/master/simple_exponential_smoothing_exmaple.ipynb](https://github.com/ohjinjin/TimeSeries_Lab/blob/master/simple_exponential_smoothing_exmaple.ipynb)
<br/>

단순지수평활법에 해당하는 ses()를 호출할 때 인수들로는 가장 중요한 alpha값을 0.2를 포함해 ts 객체와 초기값 그냥 그대로 가져오는 simple설정을 함께 넘겨줍니다.

각 오차함수값들을 확인해보세요!

단순지수평활법은 아주 잔잔하고 추세나 계절성이 없는 데이터들에 적용하면 좋은 분석법입니다.

이번엔 optimal로 계산을 한번 해봅시다
파라미터로 h=3 으로 주게되면 미래값을 3개정도 예측해서 보여달라는 뜻이 됩니다.

초기값을 optimal로 하게되면 초기값하고 알파값도 optimal(최적)한 값으로 찾아서 알아서 해줍니다.

24페이지까지 실습해볼것
fb 데이터 가지고 이동평균, 선형이동평균, 가중이동평균 엑셀로 분석하고 각 평활법 별 차트그려주시
월요일전까지..


(수정중)